if("decline.beta" %in% names(pars_use)) {
pars_use$beta <- pars_use$beta*exp(-20*pars_use$decline.beta)
}
out.noint <- model_output_proj(pars_use, pars.baseline, ystart.noint, tmax=time_proj)
#also calculate outputs over time
out.noint$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.noint$y), 12)
out.noint$out_time$time <- out.noint$out_time$time - 121
# ACTIVE CASE FINDING
names.nat.hist <- rownames(matind)
tb <- c(which(names.nat.hist %in% paste0('AA', 1:scen$n.active)),
which(names.nat.hist %in% paste0('SA', 1:scen$n.active)))
#define additional parameters - not used if % cured by ACF is specified in the SLURM script
acf_covg <- 0.7
test_sens <- 0.65
p_cure <- pars_use$k
if(is.na(cures_acf)) {
cures_acf <- acf_covg*test_sens*p_cure
}
ystart.acf <- ystart.noint
for(i in 1:length(acf_years)) {
cur_acf_time <- acf_years[[i]]
next_acf_time <- ifelse(i==length(acf_years), time_proj, acf_years[[i+1]])
if(cur_acf_time==next_acf_time) {
break
}
#ACF happens up front: AA and SA -> R
for(a in acf_ages) {
ystart.acf[matind["R",1,a]] <- sum(cures_acf*ystart.acf[matind[tb,1,a]]) + ystart.acf[matind["R",1,a]] #sum over symptomatic and asymptomatic TB for susceptible pop
ystart.acf[matind["R",2,a]] <- sum(cures_acf*ystart.acf[matind[tb,2,a]]) + ystart.acf[matind["R",2,a]] #sum over symptomatic and asymptomatic TB for resistor pop
ystart.acf[matind[tb, , a]] <- (1-cures_acf)* ystart.acf[matind[tb, , a]]
}
#then run model for 20 years with updated starting state
out.acf_tmp <- model_output_proj(pars_use, pars.baseline, ystart.acf, tmax=(next_acf_time - cur_acf_time))
#bind to out.acf and update ystart
if(i==1) {
out.acf <- out.acf_tmp
} else {
out.acf$y <- rbind(out.acf$y %>% filter(time!=cur_acf_time), out.acf_tmp$y %>% mutate(time=time+cur_acf_time))
}
out.acf$outputs <- unlist(out.acf_tmp$outputs)
names(out.acf$outputs) <- output_names
ystart.acf <- unlist(tail(out.acf_tmp$y, 1)[2:ncol(out.acf_tmp$y)])
}
#also calculate outputs over time
out.acf$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.acf$y), 12)
out.acf$out_time$time <- out.acf$out_time$time - 121
#TPT PROVISION
ltbi <- c(which(names.nat.hist %in% c("L1", "L2", "L3"))) #needs editing if >3 LTBI states
#define additional parameters
tpt_covg <- acf_covg
tst_read <- 0.865
tst_sens <- 0.9
tpt_uptake <- 0.85
tpt_completion <- 0.85
tpt_efficacy <- 0.69
cures_tpt <- tpt_covg*tst_read*tst_sens*tpt_uptake*tpt_completion*tpt_efficacy
#add TPT to ACF
ystart.tpt <- ystart.noint
for(i in 1:length(acf_years)) {
cur_acf_time <- acf_years[[i]]
next_acf_time <- ifelse(i==length(acf_years), time_proj, acf_years[[i+1]])
if(cur_acf_time==next_acf_time) {
break
}
#ACF and TPT happen up front: AA, SA, L1, L2 -> R
for(a in acf_ages) {
ystart.tpt[matind["R",1,a]] <- sum(cures_acf*ystart.tpt[matind[tb,1,a]]) + ystart.tpt[matind["R",1,a]] #sum over symptomatic and asymptomatic TB for susceptible pop
ystart.tpt[matind["R",2,a]] <- sum(cures_acf*ystart.tpt[matind[tb,2,a]]) + ystart.tpt[matind["R",2,a]] #sum over symptomatic and asymptomatic TB for resistor pop
ystart.tpt[matind[tb, , a]] <- (1-cures_acf)* ystart.tpt[matind[tb, , a]]
ystart.tpt[matind["R",1,a]] <- sum(cures_tpt*ystart.tpt[matind[ltbi,1,a]]) + ystart.tpt[matind["R",1,a]] #sum over LTBI states for susceptible pop
ystart.tpt[matind["R",2,a]] <- sum(cures_tpt*ystart.tpt[matind[ltbi,2,a]]) + ystart.tpt[matind["R",2,a]] #sum over LTBI states for resistor pop
ystart.tpt[matind[ltbi, , a]] <- (1-cures_tpt)*ystart.tpt[matind[ltbi, , a]]
}
#then run model for 20 years with updated starting state
out.tpt_tmp <- model_output_proj(pars_use, pars.baseline, ystart.tpt, tmax=(next_acf_time - cur_acf_time))
#bind to out.tpt and update ystart
if(i==1) {
out.tpt <- out.tpt_tmp
} else {
out.tpt$y <- rbind(out.tpt$y %>% filter(time!=cur_acf_time), out.tpt_tmp$y %>% mutate(time=time+cur_acf_time))
}
out.tpt$outputs <- unlist(out.tpt_tmp$outputs)
names(out.tpt$outputs) <- output_names
ystart.tpt <- unlist(tail(out.tpt_tmp$y, 1)[2:ncol(out.tpt_tmp$y)])
}
#also calculate outputs over time
out.tpt$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.tpt$y), 12)
out.tpt$out_time$time <- out.tpt$out_time$time - 121
#combine everything
out.noint$outputs <- unlist(out.noint$outputs)
names(out.noint$outputs) <- output_names
outputs <- rbind(as.data.frame(t(unlist(out.noint$outputs))) %>% mutate(scenario="No Intervention"),
as.data.frame(t(out.acf$outputs)) %>% mutate(scenario="ACF"),
as.data.frame(t(out.tpt$outputs)) %>% mutate(scenario="ACF & TPT")) %>%
mutate(array=pars_use$array, sample=pars_use$sample, round=pars_use$round, array2=pars_use$array2, count=pars_use$count)
out_time <- rbind(out.noint$out_time %>% mutate(scenario="No Intervention"),
out.acf$out_time %>% mutate(scenario="ACF"),
out.tpt$out_time %>% mutate(scenario="ACF & TPT")) %>%
mutate(array=pars_use$array, sample=pars_use$sample, round=pars_use$round, array2=pars_use$array2, count=pars_use$count)
outputs_all <- bind_rows(outputs_all, outputs)
out_time_all <- bind_rows(out_time_all, out_time)
}
outputs_all <- data.frame()
out_time_all <- data.frame()
for(js in 1:nrow(post_sub)){
print(js)
pars_use <- post_sub[js,]
#BURN IN 20 YEARS OF TX IMPROVEMENTS (need to do this again to get outputs, like incidence, over time)
ystart.burn <- unlist(ystart_sub[js, ])
out.burn <- model_output_proj(pars_use, pars.baseline, ystart.burn)
output_names <- names(out.burn$outputs)
# NO INTERVENTION
ystart.noint <- unlist(out.burn$y[nrow(out.burn$y), 2:ncol(out.burn$y)])
y.lastyears <- out.burn$y[(nrow(out.burn$y)-120):nrow(out.burn$y), ]
y.lastyears[,"time"] <- seq(from=-10, to=0, by=1/12)
#don't continue to increase omega after 20 year end of burn-in
if("increase.omega" %in% names(pars_use)) {
pars_use$omega <- pars_use$omega*(1+20*pars_use$increase.omega)
pars_use$increase.omega <- 0
}
#do keep declining beta, but incorporate 20 years burn-in to base beta value for projections
if("decline.beta" %in% names(pars_use)) {
pars_use$beta <- pars_use$beta*exp(-20*pars_use$decline.beta)
}
out.noint <- model_output_proj(pars_use, pars.baseline, ystart.noint, tmax=time_proj)
#also calculate outputs over time
out.noint$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.noint$y), 12)
out.noint$out_time$time <- out.noint$out_time$time - 121
# ACTIVE CASE FINDING
names.nat.hist <- rownames(matind)
tb <- c(which(names.nat.hist %in% paste0('AA', 1:n.active)),
which(names.nat.hist %in% paste0('SA', 1:n.active)))
#define additional parameters - not used if % cured by ACF is specified in the SLURM script
acf_covg <- 0.7
test_sens <- 0.65
p_cure <- pars_use$k
if(is.na(cures_acf)) {
cures_acf <- acf_covg*test_sens*p_cure
}
ystart.acf <- ystart.noint
for(i in 1:length(acf_years)) {
cur_acf_time <- acf_years[[i]]
next_acf_time <- ifelse(i==length(acf_years), time_proj, acf_years[[i+1]])
if(cur_acf_time==next_acf_time) {
break
}
#ACF happens up front: AA and SA -> R
for(a in acf_ages) {
ystart.acf[matind["R",1,a]] <- sum(cures_acf*ystart.acf[matind[tb,1,a]]) + ystart.acf[matind["R",1,a]] #sum over symptomatic and asymptomatic TB for susceptible pop
ystart.acf[matind["R",2,a]] <- sum(cures_acf*ystart.acf[matind[tb,2,a]]) + ystart.acf[matind["R",2,a]] #sum over symptomatic and asymptomatic TB for resistor pop
ystart.acf[matind[tb, , a]] <- (1-cures_acf)* ystart.acf[matind[tb, , a]]
}
#then run model for 20 years with updated starting state
out.acf_tmp <- model_output_proj(pars_use, pars.baseline, ystart.acf, tmax=(next_acf_time - cur_acf_time))
#bind to out.acf and update ystart
if(i==1) {
out.acf <- out.acf_tmp
} else {
out.acf$y <- rbind(out.acf$y %>% filter(time!=cur_acf_time), out.acf_tmp$y %>% mutate(time=time+cur_acf_time))
}
out.acf$outputs <- unlist(out.acf_tmp$outputs)
names(out.acf$outputs) <- output_names
ystart.acf <- unlist(tail(out.acf_tmp$y, 1)[2:ncol(out.acf_tmp$y)])
}
#also calculate outputs over time
out.acf$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.acf$y), 12)
out.acf$out_time$time <- out.acf$out_time$time - 121
#TPT PROVISION
ltbi <- c(which(names.nat.hist %in% c("L1", "L2", "L3"))) #needs editing if >3 LTBI states
#define additional parameters
tpt_covg <- acf_covg
tst_read <- 0.865
tst_sens <- 0.9
tpt_uptake <- 0.85
tpt_completion <- 0.85
tpt_efficacy <- 0.69
cures_tpt <- tpt_covg*tst_read*tst_sens*tpt_uptake*tpt_completion*tpt_efficacy
#add TPT to ACF
ystart.tpt <- ystart.noint
for(i in 1:length(acf_years)) {
cur_acf_time <- acf_years[[i]]
next_acf_time <- ifelse(i==length(acf_years), time_proj, acf_years[[i+1]])
if(cur_acf_time==next_acf_time) {
break
}
#ACF and TPT happen up front: AA, SA, L1, L2 -> R
for(a in acf_ages) {
ystart.tpt[matind["R",1,a]] <- sum(cures_acf*ystart.tpt[matind[tb,1,a]]) + ystart.tpt[matind["R",1,a]] #sum over symptomatic and asymptomatic TB for susceptible pop
ystart.tpt[matind["R",2,a]] <- sum(cures_acf*ystart.tpt[matind[tb,2,a]]) + ystart.tpt[matind["R",2,a]] #sum over symptomatic and asymptomatic TB for resistor pop
ystart.tpt[matind[tb, , a]] <- (1-cures_acf)* ystart.tpt[matind[tb, , a]]
ystart.tpt[matind["R",1,a]] <- sum(cures_tpt*ystart.tpt[matind[ltbi,1,a]]) + ystart.tpt[matind["R",1,a]] #sum over LTBI states for susceptible pop
ystart.tpt[matind["R",2,a]] <- sum(cures_tpt*ystart.tpt[matind[ltbi,2,a]]) + ystart.tpt[matind["R",2,a]] #sum over LTBI states for resistor pop
ystart.tpt[matind[ltbi, , a]] <- (1-cures_tpt)*ystart.tpt[matind[ltbi, , a]]
}
#then run model for 20 years with updated starting state
out.tpt_tmp <- model_output_proj(pars_use, pars.baseline, ystart.tpt, tmax=(next_acf_time - cur_acf_time))
#bind to out.tpt and update ystart
if(i==1) {
out.tpt <- out.tpt_tmp
} else {
out.tpt$y <- rbind(out.tpt$y %>% filter(time!=cur_acf_time), out.tpt_tmp$y %>% mutate(time=time+cur_acf_time))
}
out.tpt$outputs <- unlist(out.tpt_tmp$outputs)
names(out.tpt$outputs) <- output_names
ystart.tpt <- unlist(tail(out.tpt_tmp$y, 1)[2:ncol(out.tpt_tmp$y)])
}
#also calculate outputs over time
out.tpt$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.tpt$y), 12)
out.tpt$out_time$time <- out.tpt$out_time$time - 121
#combine everything
out.noint$outputs <- unlist(out.noint$outputs)
names(out.noint$outputs) <- output_names
outputs <- rbind(as.data.frame(t(unlist(out.noint$outputs))) %>% mutate(scenario="No Intervention"),
as.data.frame(t(out.acf$outputs)) %>% mutate(scenario="ACF"),
as.data.frame(t(out.tpt$outputs)) %>% mutate(scenario="ACF & TPT")) %>%
mutate(array=pars_use$array, sample=pars_use$sample, round=pars_use$round, array2=pars_use$array2, count=pars_use$count)
out_time <- rbind(out.noint$out_time %>% mutate(scenario="No Intervention"),
out.acf$out_time %>% mutate(scenario="ACF"),
out.tpt$out_time %>% mutate(scenario="ACF & TPT")) %>%
mutate(array=pars_use$array, sample=pars_use$sample, round=pars_use$round, array2=pars_use$array2, count=pars_use$count)
outputs_all <- bind_rows(outputs_all, outputs)
out_time_all <- bind_rows(out_time_all, out_time)
}
outputs_all <- data.frame()
out_time_all <- data.frame()
for(js in 1:nrow(post_sub)){
print(js)
pars_use <- post_sub[js,]
#BURN IN 20 YEARS OF TX IMPROVEMENTS (need to do this again to get outputs, like incidence, over time)
ystart.burn <- unlist(ystart_sub[js, ])
out.burn <- model_output_proj(pars_use, pars.baseline, ystart.burn)
output_names <- names(out.burn$outputs)
# NO INTERVENTION
ystart.noint <- unlist(out.burn$y[nrow(out.burn$y), 2:ncol(out.burn$y)])
y.lastyears <- out.burn$y[(nrow(out.burn$y)-120):nrow(out.burn$y), ]
y.lastyears[,"time"] <- seq(from=-10, to=0, by=1/12)
#don't continue to increase omega after 20 year end of burn-in
if("increase.omega" %in% names(pars_use)) {
pars_use$omega <- pars_use$omega*(1+20*pars_use$increase.omega)
pars_use$increase.omega <- 0
}
#do keep declining beta, but incorporate 20 years burn-in to base beta value for projections
if("decline.beta" %in% names(pars_use)) {
pars_use$beta <- pars_use$beta*exp(-20*pars_use$decline.beta)
}
out.noint <- model_output_proj(pars_use, pars.baseline, ystart.noint, tmax=time_proj)
#also calculate outputs over time
out.noint$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.noint$y), 12)
out.noint$out_time$time <- out.noint$out_time$time - 121
# ACTIVE CASE FINDING
names.nat.hist <- rownames(matind)
tb <- c(which(names.nat.hist %in% paste0('AA', 1:n.active)),
which(names.nat.hist %in% paste0('SA', 1:n.active)))
#define additional parameters - not used if % cured by ACF is specified in the SLURM script
acf_covg <- 0.7
test_sens <- 0.65
p_cure <- pars_use$k
cures_acf <- acf_covg*test_sens*p_cure
ystart.acf <- ystart.noint
for(i in 1:length(acf_years)) {
cur_acf_time <- acf_years[[i]]
next_acf_time <- ifelse(i==length(acf_years), time_proj, acf_years[[i+1]])
if(cur_acf_time==next_acf_time) {
break
}
#ACF happens up front: AA and SA -> R
for(a in acf_ages) {
ystart.acf[matind["R",1,a]] <- sum(cures_acf*ystart.acf[matind[tb,1,a]]) + ystart.acf[matind["R",1,a]] #sum over symptomatic and asymptomatic TB for susceptible pop
ystart.acf[matind["R",2,a]] <- sum(cures_acf*ystart.acf[matind[tb,2,a]]) + ystart.acf[matind["R",2,a]] #sum over symptomatic and asymptomatic TB for resistor pop
ystart.acf[matind[tb, , a]] <- (1-cures_acf)* ystart.acf[matind[tb, , a]]
}
#then run model for 20 years with updated starting state
out.acf_tmp <- model_output_proj(pars_use, pars.baseline, ystart.acf, tmax=(next_acf_time - cur_acf_time))
#bind to out.acf and update ystart
if(i==1) {
out.acf <- out.acf_tmp
} else {
out.acf$y <- rbind(out.acf$y %>% filter(time!=cur_acf_time), out.acf_tmp$y %>% mutate(time=time+cur_acf_time))
}
out.acf$outputs <- unlist(out.acf_tmp$outputs)
names(out.acf$outputs) <- output_names
ystart.acf <- unlist(tail(out.acf_tmp$y, 1)[2:ncol(out.acf_tmp$y)])
}
#also calculate outputs over time
out.acf$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.acf$y), 12)
out.acf$out_time$time <- out.acf$out_time$time - 121
#TPT PROVISION
ltbi <- c(which(names.nat.hist %in% c("L1", "L2", "L3"))) #needs editing if >3 LTBI states
#define additional parameters
tpt_covg <- acf_covg
tst_read <- 0.865
tst_sens <- 0.9
tpt_uptake <- 0.85
tpt_completion <- 0.85
tpt_efficacy <- 0.69
cures_tpt <- tpt_covg*tst_read*tst_sens*tpt_uptake*tpt_completion*tpt_efficacy
#add TPT to ACF
ystart.tpt <- ystart.noint
for(i in 1:length(acf_years)) {
cur_acf_time <- acf_years[[i]]
next_acf_time <- ifelse(i==length(acf_years), time_proj, acf_years[[i+1]])
if(cur_acf_time==next_acf_time) {
break
}
#ACF and TPT happen up front: AA, SA, L1, L2 -> R
for(a in acf_ages) {
ystart.tpt[matind["R",1,a]] <- sum(cures_acf*ystart.tpt[matind[tb,1,a]]) + ystart.tpt[matind["R",1,a]] #sum over symptomatic and asymptomatic TB for susceptible pop
ystart.tpt[matind["R",2,a]] <- sum(cures_acf*ystart.tpt[matind[tb,2,a]]) + ystart.tpt[matind["R",2,a]] #sum over symptomatic and asymptomatic TB for resistor pop
ystart.tpt[matind[tb, , a]] <- (1-cures_acf)* ystart.tpt[matind[tb, , a]]
ystart.tpt[matind["R",1,a]] <- sum(cures_tpt*ystart.tpt[matind[ltbi,1,a]]) + ystart.tpt[matind["R",1,a]] #sum over LTBI states for susceptible pop
ystart.tpt[matind["R",2,a]] <- sum(cures_tpt*ystart.tpt[matind[ltbi,2,a]]) + ystart.tpt[matind["R",2,a]] #sum over LTBI states for resistor pop
ystart.tpt[matind[ltbi, , a]] <- (1-cures_tpt)*ystart.tpt[matind[ltbi, , a]]
}
#then run model for 20 years with updated starting state
out.tpt_tmp <- model_output_proj(pars_use, pars.baseline, ystart.tpt, tmax=(next_acf_time - cur_acf_time))
#bind to out.tpt and update ystart
if(i==1) {
out.tpt <- out.tpt_tmp
} else {
out.tpt$y <- rbind(out.tpt$y %>% filter(time!=cur_acf_time), out.tpt_tmp$y %>% mutate(time=time+cur_acf_time))
}
out.tpt$outputs <- unlist(out.tpt_tmp$outputs)
names(out.tpt$outputs) <- output_names
ystart.tpt <- unlist(tail(out.tpt_tmp$y, 1)[2:ncol(out.tpt_tmp$y)])
}
#also calculate outputs over time
out.tpt$out_time <- calc_outputs_time(rbind(head(y.lastyears, -1), out.tpt$y), 12)
out.tpt$out_time$time <- out.tpt$out_time$time - 121
#combine everything
out.noint$outputs <- unlist(out.noint$outputs)
names(out.noint$outputs) <- output_names
outputs <- rbind(as.data.frame(t(unlist(out.noint$outputs))) %>% mutate(scenario="No Intervention"),
as.data.frame(t(out.acf$outputs)) %>% mutate(scenario="ACF"),
as.data.frame(t(out.tpt$outputs)) %>% mutate(scenario="ACF & TPT")) %>%
mutate(array=pars_use$array, sample=pars_use$sample, round=pars_use$round, array2=pars_use$array2, count=pars_use$count)
out_time <- rbind(out.noint$out_time %>% mutate(scenario="No Intervention"),
out.acf$out_time %>% mutate(scenario="ACF"),
out.tpt$out_time %>% mutate(scenario="ACF & TPT")) %>%
mutate(array=pars_use$array, sample=pars_use$sample, round=pars_use$round, array2=pars_use$array2, count=pars_use$count)
outputs_all <- bind_rows(outputs_all, outputs)
out_time_all <- bind_rows(out_time_all, out_time)
}
#fix names
names(outputs_all) <- gsub("\\..*$", "", names(outputs_all))
View(outputs_all)
file_ending <- paste0(scenario, "_", repeat_acf, "yrs_", part)
file_ending
write.csv(outputs_all, file=paste0(path, "/projections_", file_ending, ".csv"), row.names=F)
save(out_time_all, file=paste0(path, "/projections_time_", file_ending, ".Rda"))
library(ggplot2)
ggplot(out_time, aes(x=time, y=inc, color=scenario)) +
geom_line() +
theme_bw()
ggplot(out_time, aes(x=time, y=prev, color=scenario)) +
geom_line() +
theme_bw()
ggplot(out_time, aes(x=time, y=mort, color=scenario)) +
geom_line() +
theme_bw()
ggplot(out_time, aes(x=time, y=notif, color=scenario)) +
geom_line() +
theme_bw()
library(deSolve)
library(mvtnorm)
library(flexsurv)
library(lhs)
library(matrixStats)
library(dplyr)
library(stringr)
scenario <- "clearance"
path <- "imis3_omega_increase"
repeat_acf <- 2
files <- list.files(path=path, pattern=paste0("projections_time_", scenario, "_", repeat_acf, "yrs_"))
print(files)
file_numbers <- as.numeric(str_extract(files, "(?<=_)[0-9]+(?=\\.Rda)"))
print(file_numbers)
arrays <- max(file_numbers)
print(arrays)
out_time_comb <- data.frame()
outputs_comb <- data.frame()
for(i in 1:arrays) {
print(i)
load(paste0(path, "/projections_time_", scenario, "_", repeat_acf, "yrs_", i, ".Rda"))
outputs <- read.csv(paste0(path, "/projections_", scenario, "_", repeat_acf, "yrs_", i, ".csv"))
out_time_comb <- bind_rows(out_time_comb, out_time_all)
outputs_comb <- bind_rows(outputs_comb, outputs)
}
#keep a selection of outcomes at all month time steps
out_time_sub <- out_time_comb %>% select(time, cases, deaths, pop, inc, prev, mort, prev_ltbi, ari_all,
scenario, array, sample, round, array2, count)
#calculate cumulative and incremental outcomes
out_time_sub_tmp <- out_time_sub %>% group_by(scenario, array, sample, round, array2) %>%
filter(time>=0) %>% arrange(time) %>%
mutate(cum_cases=cumsum(cases),cum_deaths=cumsum(deaths))
#calculate cumulative and incremental outcomes
out_time_sub <- out_time_sub %>%
group_by(time, array, sample, round, array2) %>%
mutate(inc_decline=(inc[scenario=="No Intervention"] - inc)/inc[scenario=="No Intervention"],
mort_decline=(mort[scenario=="No Intervention"] - mort)/mort[scenario=="No Intervention"],
inc_decline_prop_acf=if_else(inc_decline[scenario=="ACF"]<0, 0, inc_decline[scenario=="ACF"]/inc_decline[scenario=="ACF & TPT"]),
mort_decline_prop_acf=if_else(mort_decline[scenario=="ACF"]<0, 0, mort_decline[scenario=="ACF"]/mort_decline[scenario=="ACF & TPT"]))
#keep a selection of outcomes at all month time steps
out_time_sub <- out_time_comb %>% select(time, pop, inc, prev, mort, prev_ltbi, ari_all,
scenario, array, sample, round, array2, count)
#calculate cumulative and incremental outcomes
out_time_sub <- out_time_sub %>%
group_by(time, array, sample, round, array2) %>%
mutate(inc_decline=(inc[scenario=="No Intervention"] - inc)/inc[scenario=="No Intervention"],
mort_decline=(mort[scenario=="No Intervention"] - mort)/mort[scenario=="No Intervention"],
inc_decline_prop_acf=if_else(inc_decline[scenario=="ACF"]<0, 0, inc_decline[scenario=="ACF"]/inc_decline[scenario=="ACF & TPT"]),
mort_decline_prop_acf=if_else(mort_decline[scenario=="ACF"]<0, 0, mort_decline[scenario=="ACF"]/mort_decline[scenario=="ACF & TPT"]))
out_time_sub <- out_time_sub %>% ungroup() %>%
group_by(scenario, array, sample, round, array2) %>%
mutate(inc_decline0=(inc[time==0] - inc)/inc[time==0],
mort_decline0=(mort[time==0] - mort)/mort[time==0])
View(out_time_sub)
#duplicate as needed to reintroduce weights
out_time_sub <- out_time_sub[rep(seq(nrow(out_time_sub)), out_time_sub$count), ]
View(outputs_comb)
#take means and CIs
out_time_sum <- out_time_sub %>% group_by(time, scenario) %>%
select(-c(array, sample, round, array2, count)) %>%
summarise_all(.funs=list(mean=~mean(., na.rm=T),
lb=~quantile(., p=0.025, na.rm=T),
ub=~quantile(., p=0.975, na.rm=T)))
#save full distributions for selected outputs at 10 yrs
out_all <- out_time_sub %>% filter(time==120)
View(out_all)
View(out_time_sum)
write.csv(out_time_sum, file=paste0(path, "/projections_time_sum_", scenario, "_", repeat_acf, "yrs.csv"), row.names=F)
write.csv(out_all, file=paste0(path, "/projections_all_10_", scenario, "_", repeat_acf, "yrs.csv"), row.names=F)
library(Hmisc)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(scales)
library(ggridges)
library(MetBrewer)
library(ggcorrplot)
yr_lab <- "2yrs"
out_comb <- data.frame()
out_time_comb <- data.frame()
out_all_comb <- data.frame()
version <- "clearance"
acf_yr
acf_yr <- 2
out <- read.csv(paste0(path, "/projections_sum_", version, "_", acf_yr, "yrs.csv"))
path <- "imis3_omega_increase"
out_all <- read.csv(paste0(path, "/projections_all_10_", version, "_", acf_yr, "yrs.csv"))
out_time <- read.csv(paste0(path, "/projections_time_sum_", version, "_", acf_yr, "yrs.csv"))
out_all_comb <- bind_rows(out_all_comb, out_all)
out_time_comb <- bind_rows(out_time_comb, out_time)
#remove outcomes for interventions in pre-intervention years ("no intervention" only)
out_time_comb <- out_time_comb %>%
mutate_at(vars(ends_with("_mean")), ~if_else(scenario=="No Intervention"|time>=0, ., as.numeric(NA)))
#add text labels for incidence changes (to use in main figure)
out_time_comb <- out_time_comb %>%
mutate(inc_decline_lab=paste0(round(inc_decline_mean*100), "% [", round(inc_decline_lb*100), "-", round(inc_decline_ub*100), "%]"))
ggplot(out_time_tmp %>% filter(time>=-5*12 & time<=12*10),
aes(x=time/12, y=inc_mean, color=scenario, fill=scenario)) +
geom_line(linewidth=1) +
geom_vline(aes(xintercept=0), linetype="dashed") +
geom_text(data=out_time_tmp %>% filter(time==12*10 & scenario!="No Intervention" & inc_decline_version=="omega_increase"),
aes(label=inc_decline_lab),
nudge_x=-2, nudge_y=-10, size=3, fontface="bold", show.legend=F) +
scale_y_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.01))) +
scale_color_manual(values=colors) +
labs(x="Year", y="Annual incidence per 100,000", color="") +
theme_bw() + theme(panel.grid=element_blank(),
legend.position="right")
#########################
# MAIN FIGURE           #
#########################
#incidence over time - 2 panels only
out_time_tmp <- out_time_comb %>%
mutate(lab_full=str_remove(lab_full, ", increased treatment")) #not needed for main graph
ggplot(out_time_comb %>% filter(time>=-5*12 & time<=12*10),
aes(x=time/12, y=inc_mean, color=scenario, fill=scenario)) +
geom_line(linewidth=1) +
geom_vline(aes(xintercept=0), linetype="dashed") +
geom_text(data=out_time_tmp %>% filter(time==12*10 & scenario!="No Intervention" & inc_decline_version=="omega_increase"),
aes(label=inc_decline_lab),
nudge_x=-2, nudge_y=-10, size=3, fontface="bold", show.legend=F) +
scale_y_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.01))) +
scale_color_manual(values=colors) +
labs(x="Year", y="Annual incidence per 100,000", color="") +
theme_bw() + theme(panel.grid=element_blank(),
legend.position="right")
ggplot(out_time_comb %>% filter(time>=-5*12 & time<=12*10),
aes(x=time/12, y=inc_mean, color=scenario, fill=scenario)) +
geom_line(linewidth=1) +
geom_vline(aes(xintercept=0), linetype="dashed") +
geom_text(data=out_time_comb %>% filter(time==12*10 & scenario!="No Intervention"),
aes(label=inc_decline_lab),
nudge_x=-2, nudge_y=-10, size=3, fontface="bold", show.legend=F) +
scale_y_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.01))) +
scale_color_manual(values=colors) +
labs(x="Year", y="Annual incidence per 100,000", color="") +
theme_bw() + theme(panel.grid=element_blank(),
legend.position="right")
ggplot(out_time_comb %>% filter(time>=-5*12 & time<=12*10),
aes(x=time/12, y=inc_mean, color=scenario, fill=scenario)) +
geom_line(linewidth=1) +
geom_vline(aes(xintercept=0), linetype="dashed") +
geom_text(data=out_time_comb %>% filter(time==12*10 & scenario!="No Intervention"),
aes(label=inc_decline_lab),
nudge_x=-2, nudge_y=-10, size=3, fontface="bold", show.legend=F) +
scale_y_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.01))) +
labs(x="Year", y="Annual incidence per 100,000", color="") +
theme_bw() + theme(panel.grid=element_blank(),
legend.position="right")
500/20
